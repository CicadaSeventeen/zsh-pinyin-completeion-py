import socket
import os
import sys
import json

def main(target,path='.'):
# 获得合适的变量来建立socket
    XDG_RUNTIME_DIR = os.environ.get("XDG_RUNTIME_DIR")
    SHELL_PID = os.getppid()
    socket_path = XDG_RUNTIME_DIR + '/' + str(SHELL_PID)
# 检查socket文件是否存在
    if not os.path.exists(socket_path):
        sys.stderr.write("Socket Error")
        exit(1)
# 创建Unix Domain Socket客户端
    client = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)

    try:
        client.connect(socket_path)  # 连接到socket文件
        #print(dict(os.environ))
        #print()
        #print(json.dumps(str(dict(os.environ))))
        client_data = '\n'.join([target,path,json.dumps(dict(os.environ))])
        client.send(client_data.encode())
        # 接收服务器回复
        server_data = json.loads(client.recv(4096).decode())
        # 解析服务器发送的字符串数组
        #strings = server_data.split('\n')
        #for i, string in enumerate(strings):
        #    print(f"  [{i}]: {string}")

    except Exception as e:
        sys.stderr.write(f"Client Error: {e}")

    finally:
        client.close()
    return server_data

if __name__ == "__main__":
    main(target='',path='.')
